<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>كشف حساب – متابعة المرشحين</title>
  <style>
    :root{
      --bg:#070918;
      --card:#0f1228;
      --panel:#0b0d21;
      --muted:rgba(255,255,255,.58);
      --accent:#fb923c;
      --green:#22c55e;
      --red:#f97373;
      --radius:16px;
      --fs-base:13.5px;
      --fs-small:11.5px;
    }
    @font-face {
      font-family: "Reqa";
      src: local("Aref Ruqaa"), local("Amiri");
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      background:var(--bg);
      color:#fff;
      font-family:"Cairo","Noto Sans Arabic",system-ui,Arial,sans-serif;
      font-size:var(--fs-base);
    }
    .wrap{max-width:1180px;margin:0 auto;padding:14px 12px 50px;}
    h1{margin:0 0 14px;font-size:26px;}

    /* كروت المرشحين */
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(210px,1fr));
      gap:12px;
      margin-bottom:14px;
    }
    .cand-card{
      background:var(--card);
      border:1px solid rgba(255,255,255,.03);
      border-radius:18px;
      padding:10px 10px 12px;
      display:flex;
      flex-direction:column;
      gap:6px;
      cursor:pointer;
      transition:transform .12s, box-shadow .12s, border .12s;
    }
    .cand-card:hover{
      transform:translateY(-3px);
      box-shadow:0 6px 20px rgba(0,0,0,.35);
      border:1px solid rgba(251,146,60,.35);
    }
    .cand-card.active{
      border:1px solid rgba(251,146,60,.7);
    }
    .cand-top{display:flex;gap:10px;align-items:center;}
    .cand-avatar{
      width:56px;height:56px;border-radius:16px;
      background:#2f3356;background-size:cover;background-position:center;flex:none;
    }
    .cand-name{font-weight:700;font-size:15px;}
    .cand-meta{font-size:11.5px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .cand-callig{font-family:"Reqa","Cairo";font-size:12.5px;color:#fff;margin-top:2px;opacity:.9;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .cand-actions{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px;}
    .btn-small{background:#ffffff12;border:0;border-radius:999px;padding:4px 12px;color:#fff;font-size:11.5px;cursor:pointer;}

    /* البانل */
    .panel{
      background:linear-gradient(160deg,#151936 0%,#070918 52%,#070918 100%);
      border:1px solid rgba(255,255,255,.03);
      border-radius:20px;
      margin-bottom:16px;
      display:none;
      overflow:hidden;
    }
    .panel.active{display:block;}

    .panel-head{
      display:flex;gap:16px;padding:14px 14px 10px;
      align-items:center;border-bottom:1px solid rgba(255,255,255,.02);flex-wrap:wrap;
    }
    .panel-big-avatar{
      width:86px;height:86px;border-radius:16px;
      background:#3a406d;background-size:cover;background-position:center;flex:none;
    }
    .panel-info{flex:1 1 220px;}
    .panel-name{font-size:20px;font-weight:700;}
    .panel-meta{font-size:12.5px;color:var(--muted);}
    .panel-slogan{font-family:"Reqa","Cairo";font-size:15px;margin-top:3px;}
    .panel-contact{font-size:11.5px;color:var(--muted);margin-top:4px;}
    .panel-contact a{color:#fff;text-decoration:underline;}
    .panel-links a{color:#fff;font-size:11.5px;margin-inline-end:10px;text-decoration:none;opacity:.75;}

    /* الإحصائيات */
    .stats{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));
      gap:10px;padding:10px 14px 0;
    }
    .stat{background:rgba(5,6,14,.15);border:1px solid rgba(255,255,255,.01);border-radius:14px;padding:7px 9px;}
    .stat-title{font-size:11.5px;color:var(--muted);}
    .stat-value{font-size:20px;font-weight:700;}

    /* الجسم */
    .panel-body{
      display:grid;grid-template-columns:1.1fr 2fr;gap:14px;padding:12px 14px 14px;
    }
    .tasks-box,.projects-box{
      background:rgba(6,7,15,.12);border:1px solid rgba(255,255,255,.01);border-radius:14px;padding:8px 10px;
    }
    .box-title{font-size:14px;font-weight:600;margin-bottom:6px;}

    /* المهام */
    .task-item{
      background:rgba(12,16,47,.35);border:1px solid rgba(255,255,255,.01);
      border-radius:10px;padding:5px 6px 4px;margin-bottom:4px;
    }
    .task-title{font-size:12.5px;font-weight:600;}
    .task-status{font-size:11px;text-transform:none;}
    .task-meta{font-size:10.5px;color:var(--muted);}
    .task-late{color:var(--red);}
    .task-sub{margin-right:12px;border-right:2px solid rgba(255,255,255,.04);padding-right:6px;}

    /* المشروعات */
    .project-card{
      background:rgba(12,16,47,.35);border:1px solid rgba(255,255,255,.01);
      border-radius:12px;padding:6px 8px;margin-bottom:6px;cursor:pointer;
    }
    .project-card:hover{background:rgba(14,20,61,.6);}
    .project-head{display:flex;justify-content:space-between;align-items:flex-start;gap:6px;}
    .project-title{font-size:13.5px;font-weight:600;}
    .badge{background:rgba(255,255,255,.07);border-radius:999px;padding:2px 6px;font-size:10.5px;}
    .progress{height:5px;background:rgba(255,255,255,.04);border-radius:999px;margin-top:5px;overflow:hidden;}
    .p-inner{height:100%;border-radius:999px;}
    .sub-line{font-size:10.5px;color:var(--muted);margin-top:4px;}
    .sub-goals{display:none;margin-top:6px;border-right:2px dashed rgba(255,255,255,.05);padding-right:6px;}
    .sub-goal{
      background:rgba(9,11,40,.4);border:1px solid rgba(255,255,255,.01);
      border-radius:8px;padding:4px 6px;margin-bottom:4px;
    }

    /* الفوتر */
    .footer{margin-top:20px;text-align:center;font-size:11.5px;color:var(--muted);}
    .footer a{color:#fff;text-decoration:none;}

    @media(max-width:950px){
      .panel-body{grid-template-columns:1fr;}
      .panel-head{flex-direction:row;}
    }
    @media(max-width:650px){
      .grid{grid-template-columns:repeat(auto-fit,minmax(160px,1fr));}
      .panel-head{flex-direction:column;align-items:flex-start;}
      body{font-size:13px;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>كشف حساب – متابعة المرشحين</h1>
    <div id="cands" class="grid"></div>
    <div id="panels"></div>
    <div class="footer">
      Powered by <a href="https://www.linkedin.com/in/ahmed-mostafa-ams/" target="_blank">Ahmed Mostafa</a> – انتخابات 2025 مرقمنة
    </div>
  </div>

  <script>
    // الداتا جاية من السيرفر مرة واحدة
    var DATA = ${JSON.stringify(data)};

    function buildPage(){
      var gc = document.getElementById('cands');
      var pc = document.getElementById('panels');
      gc.innerHTML = '';
      pc.innerHTML = '';

      DATA.candidates.forEach(function(c,idx){
        // ---- الكارت ----
        var card = document.createElement('div');
        card.className = 'cand-card' + (idx===0 ? ' active' : '');
        card.setAttribute('data-id', c.candidate_id);

        var callig = c.slogan_callig ? '<div class="cand-callig">' + c.slogan_callig + '</div>' : '';
        card.innerHTML =
          '<div class="cand-top">' +
            '<div class="cand-avatar" style="background-image:url(' + (c.photo_url || '') + ')"></div>' +
            '<div>' +
              '<div class="cand-name">' + (c.name || '') + '</div>' +
              '<div class="cand-meta">' + (c.district || '') + '</div>' +
              '<div class="cand-meta">' + (c.slogan || '') + '</div>' +
              callig +
            '</div>' +
          '</div>' +
          '<div class="cand-actions"><button class="btn-small" type="button">كشف الحساب</button></div>';

        card.onclick = function(){ togglePanel(c.candidate_id); };
        gc.appendChild(card);

        // ---- البانل ----
        var panel = document.createElement('div');
        panel.className = 'panel' + (idx===0 ? ' active' : '');
        panel.id = 'panel_' + c.candidate_id;
        panel.innerHTML = buildPanelHTML(c);
        pc.appendChild(panel);
      });

      // بعد الرسم
      attachProjectToggles();
    }

    function buildPanelHTML(c){
      var all = DATA.goals.filter(function(g){ return g.candidate_id === c.candidate_id; });
      var roots = all.filter(function(g){ return !g.parent_id; });
      var done = all.filter(function(g){ return g.status === 'done'; }).length;
      var late = all.filter(function(g){
        return g.due_date && (new Date() > new Date(g.due_date)) && g.status !== 'done';
      }).length;
      var total = all.length;
      var progress = total ? Math.round((done/total)*100) : 0;

      var html = '';

      // -------- رأس البانل --------
      html += '<div class="panel-head">';
      html += '<div class="panel-big-avatar" style="background-image:url(' + (c.photo_url || '') + ')"></div>';
      html += '<div class="panel-info">';
      html += '<div class="panel-name">' + (c.name || '') + '</div>';
      html += '<div class="panel-meta">' + (c.district || '') + '</div>';
      html += '<div class="panel-meta">' + (c.slogan || '') + '</div>';
      if(c.slogan_callig){ html += '<div class="panel-slogan">' + c.slogan_callig + '</div>'; }

      if(c.hq_address || c.campaign_phone){
        html += '<div class="panel-contact">';
        if(c.hq_address){
          if(c.hq_address.indexOf('http') === 0){
            html += '📍 <a href="' + c.hq_address + '" target="_blank">المقر على الخريطة</a> ';
          }else{
            html += '📍 ' + c.hq_address + ' ';
          }
        }
        if(c.campaign_phone){
          html += ' | ☎ ' + c.campaign_phone;
        }
        html += '</div>';
      }

      html += '<div class="panel-links">';
      if(c.facebook) html += '<a href="' + c.facebook + '" target="_blank">فيسبوك</a>';
      if(c.messenger) html += '<a href="' + c.messenger + '" target="_blank">تواصل مباشر</a>';
      html += '</div>';

      html += '</div>'; // panel-info
      html += '</div>'; // panel-head

      // -------- الإحصائيات --------
      html += '<div class="stats">';
      html += '<div class="stat"><div class="stat-title">عدد المشروعات</div><div class="stat-value">' + roots.length + '</div></div>';
      html += '<div class="stat"><div class="stat-title">إجمالي المهام</div><div class="stat-value">' + total + '</div></div>';
      html += '<div class="stat"><div class="stat-title">تم إنجازه</div><div class="stat-value">' + done + '</div></div>';
      html += '<div class="stat"><div class="stat-title">متأخر</div><div class="stat-value" style="color:' + (late? '#f97373' : '#22c55e') + ';">' + late + '</div></div>';
      html += '<div class="stat"><div class="stat-title">نسبة التقدم</div><div class="stat-value">' + progress + '%</div></div>';
      html += '</div>';

      // -------- الجسم --------
      html += '<div class="panel-body">';

      // ==== صندوق المهام ====
      html += '<div class="tasks-box"><div class="box-title">كل المهام</div>';
      if(all.length === 0){
        html += '<p class="task-meta">لا يوجد مهام.</p>';
      }else{
        // أولًا المشاريع
        roots.forEach(function(g){
          html += renderTask(g,false);
          var subs = all.filter(function(x){ return x.parent_id === g.goal_id; });
          // بعدين المهام الفرعية
          subs.forEach(function(s){
            html += renderTask(s,true);
          });
        });
      }
      html += '</div>'; // tasks-box

      // ==== صندوق المشروعات ====
      html += '<div class="projects-box"><div class="box-title">المشروعات</div>';
      if(roots.length === 0){
        html += '<p class="task-meta">لا توجد مشروعات.</p>';
      }else{
        roots.forEach(function(g){
          var subs = all.filter(function(x){ return x.parent_id === g.goal_id; });
          var p = 0;
          if(subs.length){
            var d = subs.filter(function(x){ return x.status === 'done'; }).length;
            p = Math.round((d/subs.length)*100);
          }else{
            p = (g.status === 'done') ? 100 : (g.status === 'in_progress' ? 50 : 0);
          }

          var isLate = g.due_date && (new Date() > new Date(g.due_date)) && g.status !== 'done';
          var col = isLate ? '#f97373' : (p>=85 ? '#22c55e' : (p>=45 ? '#fb923c' : '#f97373'));

          html += '<div class="project-card" data-proj="' + g.goal_id + '">';
          html += '  <div class="project-head">';
          html += '    <div><div class="project-title">' + (g.title || '(مشروع)') + '</div><div class="sub-line">' + (g.description || '') + '</div></div>';
          html += '    <div class="badge">' + p + '%</div>';
          html += '  </div>';
          html += '  <div class="progress"><div class="p-inner" style="width:' + p + '%;background:' + col + ';"></div></div>';

          if(subs.length){
            html += '  <div class="sub-line">اضغط لعرض المهام (' + subs.length + ')</div>';
            html += '  <div class="sub-goals" id="sub_' + g.goal_id + '">';
            subs.forEach(function(s){
              var lateS = s.due_date && (new Date() > new Date(s.due_date)) && s.status !== 'done';
              var colS = s.status === 'done' ? '#22c55e' : (lateS ? '#f97373' : '#fb923c');
              html += '<div class="sub-goal">';
              html += '  <div style="display:flex;justify-content:space-between;"><div>' + (s.title || '') + '</div><div style="color:' + colS + ';font-size:11px;">' + s.status + '</div></div>';
              if(s.due_date){
                var diff = Math.ceil((new Date(s.due_date)-new Date())/(1000*60*60*24));
                if(!isNaN(diff)){
                  if(diff>0) html += '<div class="task-meta">متبقي ' + diff + ' يوم</div>';
                  else if(diff===0) html += '<div class="task-meta">اليوم آخر موعد</div>';
                  else html += '<div class="task-meta task-late">متأخر ' + Math.abs(diff) + ' يوم</div>';
                }
              }
              html += '</div>';
            });
            html += '  </div>';
          }
          html += '</div>'; // project-card
        });
      }
      html += '</div>'; // projects-box

      html += '</div>'; // panel-body

      return html;
    }

    // رسم مهمة واحدة
    function renderTask(goal,isSub){
      var now = new Date();
      var late = goal.due_date && (now > new Date(goal.due_date)) && goal.status !== 'done';
      var col = goal.status === 'done' ? '#22c55e' : (late ? '#f97373' : '#fb923c');
      var txt = '';
      if(goal.due_date){
        var diff = Math.ceil((new Date(goal.due_date) - now)/(1000*60*60*24));
        if(!isNaN(diff)){
          if(diff > 0) txt = 'متبقي ' + diff + ' يوم';
          else if(diff === 0) txt = 'اليوم آخر موعد';
          else txt = 'متأخر ' + Math.abs(diff) + ' يوم';
        }
      }
      return '<div class="task-item' + (isSub ? ' task-sub' : '') + '">' +
               '<div class="task-title">' + (goal.title || '') + '</div>' +
               '<div class="task-status" style="color:' + col + ';">' + (goal.status || '') + '</div>' +
               (txt ? '<div class="task-meta ' + (txt.indexOf('متأخر')===0 ? 'task-late' : '') + '">' + txt + '</div>' : '') +
             '</div>';
    }

    // فتح/قفل بانل المرشح
    function togglePanel(id){
      var panels = document.querySelectorAll('.panel');
      var cards = document.querySelectorAll('.cand-card');
      var p = document.getElementById('panel_' + id);
      var opened = p && p.classList.contains('active');

      // اقفل الكل
      panels.forEach(function(x){ x.classList.remove('active'); });
      cards.forEach(function(x){ x.classList.remove('active'); });

      // لو مش مفتوح افتحه
      if(!opened && p){
        p.classList.add('active');
        var card = document.querySelector('.cand-card[data-id="' + id + '"]');
        if(card) card.classList.add('active');
        p.scrollIntoView({behavior:'smooth',block:'start'});
      }
    }

    // فتح/قفل مهام المشروع
    function attachProjectToggles(){
      var cards = document.querySelectorAll('.project-card');
      cards.forEach(function(card){
        card.addEventListener('click', function(){
          var projId = card.getAttribute('data-proj');
          var sub = document.getElementById('sub_' + projId);
          if(!sub) return;
          sub.style.display = (sub.style.display === 'block') ? 'none' : 'block';
        });
      });
    }

    // أول تحميل
    buildPage();
  </script>
</body>
</html>
